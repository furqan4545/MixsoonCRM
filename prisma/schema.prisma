generator client {
  provider = "prisma-client"
  output   = "../app/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ─── INFLUENCERS ───────────────────────────────────────────

model Influencer {
  id             String   @id @default(cuid())
  username       String   @unique
  profileUrl     String?
  avatarUrl      String?  // profile picture URL
  biolink        String?  // raw bio text
  bioLinkUrl     String?  // main link in bio (e.g. linktree)
  followers      Int?
  email          String?
  phone          String?
  socialLinks    String?  // JSON array of URLs
  sourceFilename String?  // which CSV file this influencer came from
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  videos   Video[]
  import   Import? @relation(fields: [importId], references: [id], onDelete: SetNull)
  importId String?
  aiEvaluations InfluencerAiEvaluation[]

  @@index([username])
  @@index([importId])
}

// ─── VIDEOS ────────────────────────────────────────────────

model Video {
  id           String   @id @default(cuid())
  influencerId String
  influencer   Influencer @relation(fields: [influencerId], references: [id], onDelete: Cascade)

  username     String   // denormalized for easy lookup

  title        String?  // "signature" from Apify
  views        Int?
  bookmarks    Int?
  uploadedAt   DateTime?
  thumbnailUrl String?  // video cover image URL
  createdAt    DateTime @default(now())

  @@index([influencerId])
  @@index([username])
}

// ─── IMPORTS ───────────────────────────────────────────────

model Import {
  id             String       @id @default(cuid())
  sourceFilename String
  rowCount       Int          @default(0)
  processedCount Int          @default(0)
  status         ImportStatus @default(PENDING)
  usernameLimit  Int          @default(-1)
  videoCount     Int          @default(20)
  saveProgress   Int          @default(0)
  saveTotal      Int          @default(0)
  errorMessage   String?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  influencers Influencer[]
  aiFilterRuns AiFilterRun[]
}

enum ImportStatus {
  PENDING
  PROCESSING
  DRAFT
  COMPLETED
  FAILED
}

// ─── AI FILTERING ───────────────────────────────────────────

model Campaign {
  id              String   @id @default(cuid())
  name            String
  targetKeywords  String[]
  avoidKeywords   String[]
  notes           String?
  strictnessDefault Int    @default(50)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  aiFilterRuns AiFilterRun[]

  @@index([name])
}

model AiFilterRun {
  id            String   @id @default(cuid())
  campaignId    String
  campaign      Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  importId      String?
  import        Import?  @relation(fields: [importId], references: [id], onDelete: SetNull)
  strictness    Int
  status        AiFilterRunStatus @default(PENDING)
  totalCount    Int @default(0)
  aiProcessedCount Int @default(0)
  reviewQueueCount Int @default(0)
  approvedCount Int @default(0)
  okishCount    Int @default(0)
  rejectedCount Int @default(0)
  failedCount   Int @default(0)
  model         String   @default("gemini-2.0-flash")
  errorMessage  String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  evaluations InfluencerAiEvaluation[]

  @@index([campaignId])
  @@index([importId])
  @@index([status])
}

model InfluencerAiEvaluation {
  id            String   @id @default(cuid())
  runId         String
  run           AiFilterRun @relation(fields: [runId], references: [id], onDelete: Cascade)
  influencerId  String
  influencer    Influencer @relation(fields: [influencerId], references: [id], onDelete: Cascade)
  prefilterLabel PreFilterLabel
  score         Int?
  bucket        AiBucket
  reasons       String?
  matchedSignals String?
  riskSignals   String?
  reviewStatus  ReviewStatus @default(NOT_REVIEWED)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([runId, influencerId])
  @@index([runId])
  @@index([influencerId])
  @@index([bucket])
  @@index([reviewStatus])
}

enum AiFilterRunStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum PreFilterLabel {
  NONE
  LIKELY_RELEVANT
  REVIEW_QUEUE
}

enum AiBucket {
  APPROVED
  OKISH
  REJECTED
  REVIEW_QUEUE
}

enum ReviewStatus {
  NOT_REVIEWED
  APPROVED_FOR_AI
  DISCARDED
  SAVED
}

// ─── NOTIFICATIONS ─────────────────────────────────────────

model Notification {
  id         String   @id @default(cuid())
  type       String   // e.g. "import_save", "ai_filter"
  status     String   @default("info") // "success" | "error" | "info"
  title      String
  message    String?
  read       Boolean  @default(false)
  importId   String?
  runId      String?  // AiFilterRun id when type is ai_filter
  createdAt  DateTime @default(now())

  @@index([read])
  @@index([createdAt])
  @@index([status])
}

// ─── RBAC ──────────────────────────────────────────────────

enum UserStatus {
  PENDING
  ACTIVE
  SUSPENDED
}

model User {
  id           String     @id @default(cuid())
  email        String     @unique
  name         String?
  passwordHash String
  status       UserStatus @default(PENDING)
  roleId       String
  role         Role       @relation(fields: [roleId], references: [id])
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  @@index([roleId])
  @@index([status])
}

model Role {
  id          String       @id @default(cuid())
  name        String       @unique // "Admin", "PIC", "Viewer"
  permissions Permission[]
  users       User[]
  createdAt   DateTime     @default(now())
}

model Permission {
  id      String @id @default(cuid())
  feature String // e.g. "data-scraper", "csv-upload"
  action  String // e.g. "read", "write", "delete"
  roleId  String
  role    Role   @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([roleId, feature, action])
  @@index([roleId])
}
